{% extends "base.html" %}

{% block title %}
    Room
{% endblock %}

{% block links %}
    <link rel="stylesheet" href="{{ url_for('test_app.static', filename= 'css/room.css') }}">
    <link rel="stylesheet" href="{{ url_for('test_app.static', filename= 'css/room_test_result.css') }}">
{% endblock %}
    
{% block content %}

    <div class="room-content" id="room-content"></div>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script src="{{ url_for('test_app.static', filename= 'js/roomFiles/add_user_block.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/roomFiles/chart_manager.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/roomFiles/timer_manager.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/roomFiles/exel_table.js') }}"></script>

    <script src="{{ url_for('test_app.static', filename= 'js/roomFiles/test_states.js') }}"></script>

    <script src="{{ url_for('test_app.static', filename= 'js/roomRenderPages/render_waite_page.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/roomRenderPages/render_author_start.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/roomRenderPages/render_question.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/roomRenderPages/render_result_test.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/roomRenderPages/render_author_result_test.js') }}"></script>

    <script>
        let username = "{{ username }}"; 
        const room = "{{ test.test_code }}"; 
        const recconect= getCookie("recconect")
        
        if (!username) {
            username= getCookie("temporaryName")
            if (!username) {
                window.location.href = `/temporary_name${room}`;
            }
        }
        
        const socket= io("/room", 
            {
                reconnection: true,
                reconnection: 7,
                reconnectionDelay: 1000
            }
        );

        const testId = Number("{{ test.id }}");
        const totalQuestion = Number("{{ test.total_questions }}");
        const authorName= "{{ test.author_name }}";

        const listQuiz = {{ list_quiz | tojson }};
        const listAnswers = {{ list_answers | tojson }};
        
        let state = getCookie("state");
        let compound= getCookie("compound")
        let timerPaused= getCookie("timeStop");
        let plusAnswerTime= 0;
        let timerInterval= null;
        let plusTimeCount= 15

        if (timerPaused === NaN){
            setCookie("timeStop", "false")
            timerPaused= false
        }else if (timerPaused == 'true'){
            timerPaused= true
        }else if (timerPaused == 'false'){
            timerPaused= false
        } 

        if (state && state.includes("authorStart")) {
            state= getCookie("state")
            let time= getCookie("time")
            renderAuthorStart(listQuiz[Number(state.slice(-1))], room, authorName, Number(state.slice(-1)), totalQuestion);
        } 
        else if (state === "authorResultTest") {
            renderAuthorResultTest(username, authorName, totalQuestion);
        } 
        else if (state === "resultTest") {
            renderResultTest(username, totalQuestion, listQuiz, listAnswers, testId);
        } else if (recconect){
            console.log("USER RECCONECT")
            clearCookie(["recconect"])

            socket.emit("reconnect_user", {
                room: room,
                username: username,
                author_name: authorName
            });
        }
        else if (state && state.includes("question")) {
            let time= getCookie("time")
            renderQuestion(Number("{{ test.id }}"), listQuiz[Number(state.slice(-1))], listAnswers[Number(state.slice(-1))], room, authorName);
        } 
        else if (state && state.includes("waite")) {
            renderWaiteQuestion("test");
        }
        else {
            if (authorName === username || compound){
                let userList= getCookie("userList")
                renderRoomMain(room, authorName, username, listQuiz, userList);
                setCookie("room", room)
    
                let messages= document.getElementById("messages");
                
                if (messages && messages.children.length != 1){
                    const emptyMessages= document.getElementById("no-messages");
                    if (emptyMessages){
                        emptyMessages.remove()
                    }
                }
            } else{
                renderWaiteQuestion("waite");
            }
        }
 
        socket.on("connect", function () {     
            socket.emit("join", {
                room: room,
                username: username
            });
        
            if (username !== authorName && !state) {                            
                fetch('https://api.ipify.org?format=text')
                    .then(r => r.text())
                    .then(ip => {
                        socket.emit("new_user_admin", {
                            room: room,
                            username: username,
                            author_name: authorName,
                            compound:  compound,
                            ip: ip
                        });
                    })
                    .catch(e => console.error("Ошибка IP:", e));
            }
        });

        socket.on("listening_to_messages", function(data) {
            let messages = document.getElementById("messages");

            if (messages != "") {
                messages.innerHTML += `<p class="other-msg">${data}</p>`;  
            };

            if (messages && messages.children.length != 1){
                const emptyMessages= document.getElementById("no-messages");
                if (emptyMessages){
                    emptyMessages.remove()
                }
            }
        });

        socket.on("author_receive_answer", function(data) {     
            let answer= data["answer"]           
            let countUsersAnswer= getCookie("countUsersAnswer");
            countUsersAnswer = Number(countUsersAnswer) + 1  
            setCookie("countUsersAnswer", countUsersAnswer)

            state = getCookie("state");    
            addUserAnswer(data["username"], answer, authorName, listQuiz[Number(state.slice(-1))]);
            
            socket.emit("get_room_size", {
                room: room,
                author_name: authorName
            });

        });

        socket.on("recieve_count_users", function(data) {  
            const COUNTUSERS= data['countUsers']
            let countUsersAnswer= getCookie("countUsersAnswer");
            
            state = getCookie("state");
        });

        socket.on("reconnect_ping", function(data) {          
            state = getCookie("state");        
            let new_state= -2
            let new_time= getCookie("time")      
            if (username === authorName){  
                if (state === "authorResultTest"){
                    new_state= -1
                    renderResultTest(username, totalQuestion, listQuiz, listAnswers, testId);
                } else{
                    new_state= Number(state.slice(-1))
                }
                console.log("AUTHOER DONE", Number(state.slice(-1)))
            }
            console.log("ALLL WHYYY DONE")
            alert(new_state)
            socket.emit("new_state", {
                room: room,
                username: data.username,
                author_name: authorName,
                new_state: new_state,
                new_time: new_time
            });
        });

        socket.on("new_state", function(data) {  
            console.log(data["new_state"], "NEWNWE STATE")
            let new_state= Number(data["new_state"])

            if (new_state === -1){
                console.log("resultTest end", new_state)
            } else if (new_state === -2){ 
                userLeaveTest()
            }else if (new_state >= 0){
                console.log("test", new_state)
                if (Number(data["new_time"]) > 1){
                    setCookie("state", `question${new_state}`)
                    console.log(new_state, "question reccconte")
                    renderQuestion(Number("{{ test.id }}"), listQuiz[Number(new_state)], listAnswers[Number(new_state)], room, authorName);
                } else{
                    setCookie("state", `waite${new_state}`)
                    console.log(new_state, "waite recconect")
                    renderWaiteQuestion("test");
                }

                checkAnswers()
            } else{
                console.log("BAD REQUEST NEW STATE")
            }
        });

        socket.on("next_question", function(data) {  
            state = getCookie("state");
            setCookie("timeStop", "false")
            timerPaused= false
            
            checkAnswers();
            plusAnswerTime= 0
            if (state != "authorResultTest") {
                let numberOfQuestion= Number(state.slice(-1));
                setCookie("time", Number(listQuiz[numberOfQuestion + 1].time))
                if (numberOfQuestion != totalQuestion - 1) {
                    setCookie("state", `question${numberOfQuestion + 1}`)
                    renderQuestion(Number("{{ test.id }}"), listQuiz[numberOfQuestion + 1], listAnswers[numberOfQuestion + 1], room, authorName);
                }
                else {
                    socket.emit("stop_test", {
                        room: room,
                        author_name: authorName
                    });
                    
                    setCookie("state", "authorResultTest")
                    renderAuthorResultTest(username, authorName, totalQuestion);
                }
            }
        });

        socket.on("result_test", function(data) {      
            checkAnswers();

            renderResultTest(username, totalQuestion, listQuiz, listAnswers, testId)

            userAnswers= getCookie("userAnswers")
            userTimers= getCookie("userTimers")
            userTokens= getCookie("userTokens")

            socket.emit("user_answers", {
                room: room,
                username: username,
                author_name: authorName,
                user_answers: userAnswers,
                user_timers: userTimers,
                user_tokens: userTokens
            });

            setCookie("state", "resultTest")
        });

        socket.on("create_user_block", function(data) {  
            if (!state){    
                if (username === data["username"]){
                    setCookie("compound", "1")
                    setCookie("room", room)
                    renderRoomMain(room, authorName, username, listQuiz);
                }  
                createUserBlock(username, authorName, data['username'], data['user_ip'], "not");
            }
        });

        socket.on("new_user_admin", function(data) {  
            let addUser= true
            let userList= getCookie("userList")
            let blockedUsers= getCookie("blockedUsers")
            let waiteUserIp= document.querySelectorAll(".user-ip")
            if (blockedUsers){
                blockedUsers= blockedUsers.split("$%^")
                
                blockedUsers.forEach(blockIp =>{
                    if (data.ip === blockIp){
                        addUser= false
                    }
                })
            }

            if (userList){
                userList= userList.split("</>")
                userList= userList.map(user => user.split("()"))

                userList.forEach(user =>{
                    console.log(user, data.ip)
                    if (user === data.ip){
                        addUser= false
                    }
                })
            }

            if (waiteUserIp){
                waiteUserIp.forEach(userIp =>{
                    console.log(userIp, data.ip)
                    if (userIp.textContent === data.ip){
                        addUser= false
                    }
                })
            }

            if (addUser && !state && !data.compound){
                createUserBlock(username, authorName, data['username'], data['ip'], "waite");
            }
        });

        socket.on('kicked', function(data) {
            clearCookie(["room", "state", "userAnswers", "compound", "countUsersAnswer", "temporaryName", "timeStop", "time"])
            window.location.href = '/'; 
        });

        socket.on('plus_time', function(data) {          
            const timer= document.getElementById("timer")
            if (!timer) return;
            
            const timerCount= getCookie("time")
            plusAnswerTime += 15
            if (timerCount && timer.textContent != "Час закінчений"){
                timer.textContent = parseInt(timerCount) + plusTimeCount
                setCookie("time", parseInt(timerCount) + plusTimeCount)
            }
        });

        socket.on('change_time', function(data) {          
            timerPaused= !timerPaused
            setCookie("timeStop", timerPaused)
            const playBtn= document.getElementById("play-btn")

            if (playBtn){
                if (timerPaused){
                    playBtn.textContent= "Play"
                }
                else{
                    playBtn.textContent= "Stop"
                }
            }
        });

        socket.on('user_disconnected', function(data) {  
            
            let messages = document.getElementById("messages");
            if (messages) {
                messages.innerHTML += `<p class="other-msg">${data['msg']}</p>`;  
            }  

            if (messages && messages.children.length != 1){
                const emptyMessages= document.getElementById("no-messages");
                if (emptyMessages){
                    emptyMessages.remove()
                }
            }

            let removeUserBlock= document.getElementById(`user${data['username']}`)

            if (removeUserBlock) {
                removeUserBlock.remove()
            }
        });

        socket.on('start_test', function(data) {   
            let stateCookies= getCookie("state")
            let state= stateCookies ? Number(stateCookies.slice(-1)) : 0;
            let messages = document.getElementById("messages");         
            if (messages){
                messages.innerHTML += `<p>Start ${data["room"]}</p>`;
            }     
            
            setCookie("time", listQuiz[0].time)
            let compoundStart= getCookie("compound")
            clearCookie(["compound"])

            if (username === data["author_name"]) {        
                setCookie("state", "authorStart0")  
                setCookie("countUsersAnswer", 0)  
                setCookie("countCorrectAnswer", 0)  
                renderAuthorStart(listQuiz[0], room, authorName, state, totalQuestion);
            }
            else if(compoundStart) {
                setCookie("state", "question0")  
                renderQuestion(Number("{{ test.id }}"), listQuiz[state], listAnswers[state], room, authorName);
            } else{
                window.location.href = '/'; 
            }
        });
    </script>
    
{% endblock %}
