{% extends "base.html" %}

{% block title %}
    Room
{% endblock %}

{% block links %}
    <link rel="stylesheet" href="{{ url_for('test_app.static', filename= 'css/room.css') }}">
{% endblock %}
    
{% block content %}

    <div class="content" id="content">

    </div>

    {% if current_user.is_authenticated %}
        <script src="{{ url_for('test_app.static', filename= 'js/get_cookies.js') }}"></script>
        <script src="{{ url_for('test_app.static', filename= 'js/render_waite_page.js') }}"></script>
        <script src="{{ url_for('test_app.static', filename= 'js/render_author_start.js') }}"></script>
        <script src="{{ url_for('test_app.static', filename= 'js/render_question.js') }}"></script>
        <script src="{{ url_for('test_app.static', filename= 'js/add_user_block.js') }}"></script>

        <script>
            
            const socket = io();
            const username = "{{ username }}";  
            const room = "{{ test.test_code }}"
            const author_name = "{{ test.author_name }}"

            let state = getCookie("state");

            if (!state) {
                socket.on("connect", function () {
                    let state = getCookie("state");
                    
                    if (state === "author_start") {
                        renderAuthorStart();
                    } 
                    else if (state === "question1") {
                        renderQuestion();
                    } 
                    else {
                        renderRoomMain(room, author_name, username);
                        let messages = document.getElementById("messages");
                        messages.innerHTML += `<p>${username} добавился в комнату </p>`; 
                    }

                    socket.emit("join", {
                        room: room,
                        username: username
                    });

                    if (username != author_name ) {
                        createUserBlock(username, author_name, username)
                        
                        socket.emit("new_user", {
                            room: room,
                            username: username
                        });
                    }

                });
                
                
                socket.on("listening_to_messages", function(data) {
                    let messages = document.getElementById("messages");
                    messages.innerHTML += `<p>${data}</p>`;  

                });

                socket.on("create_user_block", function(data) {   
                    console.log(data)  ;           
                    createUserBlock(username, author_name, data);
                });

                socket.on('kicked', function(data) {          
                    window.location.href = '/'; 
                });

                socket.on('user_disconnected', function(data) {    
                    let messages = document.getElementById("messages");
                    messages.innerHTML += `<p>${data['msg']}</p>`;  

                    let removeUserBlock= document.getElementById(`${data['username']}`)

                    if (removeUserBlock) {
                        removeUserBlock.remove()
                    }
                });

                socket.on('start_test', function(data) {
                    let messages = document.getElementById("messages");
                    messages.innerHTML += `<p>Start ${data["room"]}</p>`;
                    console.log(data["test_id"])
                    if (username === data["author_name"]) {
                        console.log("Вы начали тест");              
                        document.cookie = "state= author_start; path=/";
                        renderAuthorStart()
                    }
                    else {
                        console.log("Тест начат");
                        document.cookie = "state= question1; path=/";
                        renderQuestion()
                    }
                });

            }
            else {
                socket.on('user_disconnected', function(data) {    
                    console.log(`${data['msg']}`)
                });
            }

            function sendMessage() {
                let msgInput = document.getElementById("msg");
                let message = msgInput.value;

                if (message != ""){
                    socket.emit("message_to_chat", {
                        message: message,
                        room: room,         
                        username: username  
                    });
                }
                msgInput.value = "";
            }

            function kickUser(kick_user) {
                socket.emit("kick_user", {
                    room: room,
                    user: kick_user
                });

                let removeUserBlock= document.getElementById(`${kick_user}`)

                if (removeUserBlock) {
                    removeUserBlock.remove()
                }
            }

            function authorStartTest() {
                socket.emit("author_start_test", {
                    room: room
                });
            }
        
        </script>

    {% endif %}
    
{% endblock %}