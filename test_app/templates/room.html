{% extends "base.html" %}

{% block title %}
    Room
{% endblock %}

{% block links %}
    <link rel="stylesheet" href="{{ url_for('test_app.static', filename= 'css/room.css') }}">
{% endblock %}

{% block content %}
    <div class="waite-side">
        <div class="info-bar">
            <div class="info-text">Author: {{ username }}</div>
            <div class="info-text">Test code: <strong>{{ test.test_code }}</strong></div>
        </div>

        <div class="user-list">
            
            {% for name in list_users %}
                <div class="user-block">
                    {% if test.author_name == name %}
                        <div class="user-name">Автор: {{ name }}</div>
                    {% else %}
                        <div class="user-name">{{ name }}</div>
                        <div class="user-actions">
                            <button class="btn-remove" onclick="kickUser('{{ name }}')" type="button">Delete</button>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>


        {% if test.author_name == username %}
                <button class= "btn-start" onclick="authorStartTest()" type="button">Start</button>
        {% endif %}
    </div>


   <div class="chat">
        <h2>Chat</h2>
        <input id="msg" type="text" placeholder="Enter your message" class="msg-chat">
        <button onclick="sendMessage()" class="send-btn" type="button">Send</button>
        <div id="messages"></div>
    </div>

    {% if current_user.is_authenticated %}
        <script>
            const socket = io();
            const username = "{{ username }}";  

            console.log(username)
            const code = "{{ test.test_code }}"

            socket.on("connect", function () {
                socket.emit("join", {
                    code: code,
                    username: username
                });
            });

            socket.on("listening_to_messages", function(data) {
                console.log(data);
                let messages = document.getElementById("messages");
                messages.innerHTML += `<p>${data}</p>`;
            });

            socket.on('kicked', function(data) {
                document.cookie = "room= ''; path= /; max-age= 0";
                window.location.href = '/'; 
            });

            socket.on('start_test', function(data) {
                let messages = document.getElementById("messages");
                messages.innerHTML += `<p>Start ${data["room"]}</p>`;
                console.log(data["test_id"])
                if (username === data["author_name"]) {
                    console.log("Вы начали тест")
                }
                else {
                    //window.location.href = `/passing_test?test_id=${data["test_id"]}`;
                    window.location.href = `/`;
                }
            });

            function sendMessage() {
                let msgInput = document.getElementById("msg");
                let message = msgInput.value;

                if (message != ""){
                    console.log(code, username)
                    socket.emit("message_to_chat", {
                        message: message,
                        room: code,         
                        username: username  
                    });
                }
                msgInput.value = "";
            }

            function kickUser(kick_user) {
                socket.emit("kick_user", {
                    room: code,
                    user: kick_user
                });
            }

            function authorStartTest() {
                socket.emit("author_start_test", {
                    room: code
                }
                );
            }

        </script>

    {% endif %}

{% endblock %}