{% extends "base.html" %}

{% block title %}
    Room
{% endblock %}

{% block links %}
    <link rel="stylesheet" href="{{ url_for('test_app.static', filename= 'css/room.css') }}">
    <link rel="stylesheet" href="{{ url_for('test_app.static', filename= 'css/room_test_result.css') }}">
{% endblock %}
    
{% block content %}

    <div class="room-content" id="room-content">

    </div>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/add_user_block.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/render_waite_page.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/render_author_start.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/render_question.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/render_result_test.js') }}"></script>
    <script src="{{ url_for('test_app.static', filename= 'js/render_author_result_test.js') }}"></script>

    <script>

        let username = "{{ username }}"; 
        const room = "{{ test.test_code }}"; 
        
        if (!username) {
            username= getCookie("temporaryName")
            if (!username) {
                window.location.href = `/temporary_name${room}`;
            }
        }
        
        const socket= io({reconnection: true});

        const totalQuestion = Number("{{ test.total_questions }}");
        const testId = Number("{{ test.id }}");
        const authorName= "{{ test.author_name }}";

        const listQuiz = {{ list_quiz | tojson }};
        const listAnswers = {{ list_answers | tojson }};
        
        let state = getCookie("state");
        let compound= getCookie("compound")
        let plusAnswerTime= 0;
        let timerPaused= getCookie("timeStop");
        let timerInterval= null;

        if (timerPaused === NaN){
            document.cookie = `timeStop= false; path=/;`;
            timerPaused= false
        }else if (timerPaused == 'true'){
            timerPaused= true
        }else if (timerPaused == 'false'){
            timerPaused= false
        } 

        //window.addEventListener('beforeunload', function(){
        //    state = getCookie("state");
        //    if (state && state === "authorResultTest") {
        //        document.cookie = `state= authorLeave; max-age=3; path=/;`;
        //        document.cookie = `userAnswers=; max-age=0; path=/;`;
        //        document.cookie = `countUsersAnswer=; max-age=0; path=/;`;
        //        document.cookie = `countCorrectAnswer=; max-age=0; path=/;`;
        //    }
        //    else if (state && state=== "resultTest"){
        //        document.cookie = `state= userLeave; max-age=3; path=/;`;
        //        document.cookie = `userAnswers=; max-age=0; path=/;`;
        //        document.cookie = `countUsersAnswer=; max-age=0; path=/;`;
        //        document.cookie = `temporaryName=; max-age=0; path=/;`;
        //    }
        //    
        //});

        if (state && state.includes("authorStart")) {
            state= getCookie("state")
            let time= getCookie("time")
            renderAuthorStart(listQuiz[Number(state.slice(-1))], room, authorName, Number(state.slice(-1)), totalQuestion);
        } 
        else if (state === "authorResultTest") {
            renderAuthorResultTest(username, authorName, totalQuestion);
        } 
        else if (state === "resultTest") {
            renderResultTest(username, totalQuestion, listQuiz, listAnswers, testId);
        } 
        else if (state && state=== "authorLeave"){
            let currentURL = window.location.href;
            let roomCode = currentURL.split('room')[1]
            
            socket.emit("test_end", {
                room: roomCode
            });
            
            document.cookie = `state=; max-age=0; path=/;`;
            window.location.href = '/';  
        }
        else if (state && state=== "userLeave"){
            document.cookie = `state=; max-age=0; path=/;`;
            window.location.href = '/';  
        }
        else if (state && state.includes("question")) {
            let time= getCookie("time")
            renderQuestion(Number("{{ test.id }}"), listQuiz[Number(state.slice(-1))], listAnswers[Number(state.slice(-1))], room, authorName);
        } 
        else if (state && state.includes("waite")) {
            renderWaiteQuestion("test");
        } 
        else {
            if (authorName === username || compound){
                let userList= getCookie("userList")
                renderRoomMain(room, authorName, username, listQuiz, userList);
    
                let messages= document.getElementById("messages");
                
                if (messages && messages.children.length != 1){
                    const emptyMessages= document.getElementById("no-messages");
                    if (emptyMessages){
                        emptyMessages.remove()
                    }
                }
            } else{
                renderWaiteQuestion("waite");
            }
        }
 
        socket.on("connect", function () {     
            socket.emit("join", {
                room: room,
                username: username
            });
        
            if (username !== authorName && !state) {                            
                fetch('https://api.ipify.org?format=text')
                    .then(r => r.text())
                    .then(ip => {
                        console.log("Ваш IP:", ip);

                        socket.emit("new_user_admin", {
                            room: room,
                            username: username,
                            author_name: authorName,
                            compound:  compound,
                            ip: ip
                        });
                    })
                        .catch(e => console.error("Ошибка IP:", e));
            }
        });

        socket.on("listening_to_messages", function(data) {
            let messages = document.getElementById("messages");

            if (messages != "") {
                messages.innerHTML += `<p class="other-msg">${data}</p>`;  
            };

            if (messages && messages.children.length != 1){
                const emptyMessages= document.getElementById("no-messages");
                if (emptyMessages){
                    emptyMessages.remove()
                }
            }
        });

        socket.on("author_receive_answer", function(data) {     
            let answer= data["answer"]           
            let countUsersAnswer= getCookie("countUsersAnswer");
            countUsersAnswer = Number(countUsersAnswer) + 1  
            document.cookie = `countUsersAnswer= ${countUsersAnswer}; path=/`;

            state = getCookie("state");    
            addUserAnswer(data["username"], answer, authorName, listQuiz[Number(state.slice(-1))]);
            
            socket.emit("get_room_size", {
                room: room,
                author_name: authorName
            });

        });

        socket.on("recieve_count_users", function(data) {  
            const COUNTUSERS= data['countUsers']
            let countUsersAnswer= getCookie("countUsersAnswer");
            
            state = getCookie("state");
        });

        socket.on("next_question", function(data) {  
            state = getCookie("state");
            document.cookie = `timeStop=false; path=/;`;
            timerPaused= false
            plusAnswerTime= 0
            
            checkAnswers();
            if (state != "authorResultTest") {
                let numberOfQuestion= Number(state.slice(-1));
                document.cookie= `time=${Number(listQuiz[numberOfQuestion + 1].time)}; path=/`
                if (numberOfQuestion != totalQuestion - 1) {
                    document.cookie = `state= question${numberOfQuestion + 1}; path=/`;
                    renderQuestion(Number("{{ test.id }}"), listQuiz[numberOfQuestion + 1], listAnswers[numberOfQuestion + 1], room, authorName);
                }
                else {
                    socket.emit("stop_test", {
                        room: room,
                        author_name: authorName
                    });
                    
                    document.cookie = `state= authorResultTest; path=/`;

                    renderAuthorResultTest(username, authorName, totalQuestion);
                }
            }
        });

        socket.on("result_test", function(data) {      
            checkAnswers();

            renderResultTest(username, totalQuestion, listQuiz, listAnswers, testId);

            userAnswers= getCookie("userAnswers");

            socket.emit("user_answers", {
                    room: room,
                    username: username,
                    author_name: authorName,
                    user_answers: userAnswers
                });

            document.cookie = `state= resultTest; path=/`;
        });

        socket.on("create_user_block", function(data) {  
            if (!state){    
                if (username === data["username"]){
                    document.cookie= `compound= 1; path=/`;
                    renderRoomMain(room, authorName, username, listQuiz);
                }  
                createUserBlock(username, authorName, data['username'], data['user_ip'], "not");
            }
        });

        socket.on("new_user_admin", function(data) {  
            let addUser= true
            let blockedUsers= getCookie("blockedUsers")
            if (blockedUsers){
                blockedUsers= blockedUsers.split("$%^")
                
                blockedUsers.forEach(blockIp =>{
                    console.log(data.ip, blockIp)
                    if (data.ip === blockIp){
                        addUser= false
                    }
                })
            }

            if (addUser && !state && !data.compound){
                createUserBlock(username, authorName, data['username'], data['ip'], "waite");
            }
        });

        socket.on('kicked', function(data) {
            document.cookie = `temporaryName=; max-age=0; path=/;`;    
            document.cookie = `compound=; max-age=0; path=/;`;
            document.cookie = `time=; max-age=0; path=/;`;  

            window.location.href = '/'; 
        });

        socket.on('plus_time', function(data) {          
            const timerText= document.getElementById("timer")
            let plusTime= 15
            plusAnswerTime += 15
            if (timerText && timerText.textContent != "Час закінчений"){
                let currTime= Number(getCookie('time'))
                timerText.textContent = parseInt(currTime) + plusTime
                document.cookie = `time=${parseInt(currTime) + plusTime}; path=/;`;
            }
        });

        socket.on('change_time', function(data) {          
            timerPaused= !timerPaused
            document.cookie = `timeStop=${timerPaused}; path=/;`;
            const playBtn= document.getElementById("play-btn")

            if (playBtn){
                if (timerPaused){
                    playBtn.textContent= "Play"
                }
                else{
                    playBtn.textContent= "Stop"
                }
            }
        });

        socket.on('user_disconnected', function(data) {  
            
            let messages = document.getElementById("messages");
            if (messages) {
                messages.innerHTML += `<p class="other-msg">${data['msg']}</p>`;  
            }  

            if (messages && messages.children.length != 1){
                const emptyMessages= document.getElementById("no-messages");
                if (emptyMessages){
                    emptyMessages.remove()
                }
            }

            let removeUserBlock= document.getElementById(`user${data['username']}`)

            if (removeUserBlock) {
                removeUserBlock.remove()
            }
        });

        socket.on('start_test', function(data) {   
            let stateCookies= getCookie("state")
            let state= stateCookies ? Number(stateCookies.slice(-1)) : 0;
            let messages = document.getElementById("messages");         
            if (messages){
                messages.innerHTML += `<p>Start ${data["room"]}</p>`;
            }        
            document.cookie= `time= ${listQuiz[0].time}; path=/`
            let compoundStart= getCookie("compound")

            if (username === data["author_name"]) {          
                document.cookie = "state= authorStart0; path=/";
                document.cookie = "countUsersAnswer= 0; path=/";
                document.cookie = `countCorrectAnswer= 0; path=/`;
                renderAuthorStart(listQuiz[0], room, authorName, state, totalQuestion);
            }
            else if(compoundStart) {
                console.log("Тест начат");
                document.cookie = "state= question0; path=/";
                renderQuestion(Number("{{ test.id }}"), listQuiz[state], listAnswers[state], room, authorName);
            } else{
                window.location.href = '/'; 
            }
        });

        function nextQuestion(){
            const nextButton = document.getElementById("next-q");
            plusAnswerTime= 0

            state = getCookie("state");
            let numberOfQuestion= Number(state.slice(-1)) + 1;
            let countUsersAnswer= getCookie("countUsersAnswer");
            
            document.cookie = `timeStop=false; path=/;`;

            const userAnswers = document.getElementById("user-answers");
            userAnswers.innerHTML = ""

            const countAnswer = document.getElementById("count-answer-span");
            countAnswer.textContent= 0;
             
            document.cookie = `state= authorStart${numberOfQuestion}; path=/`;
            document.cookie = `countCorrectAnswer= 0; path=/`;

            if (numberOfQuestion == totalQuestion- 1) {
                nextButton.textContent = 'Кінець тесту'
                nextButton.removeEventListener("click", nextQuestion)
                nextButton.addEventListener("click", testStop);
            }

            document.cookie = `countUsersAnswer= 0; path=/`;
            
            const question_text = document.getElementById("author-question")
            question_text.textContent = `${listQuiz[numberOfQuestion].question_text}`
        
            const correct_answer = document.getElementById("author-correct-answer")

            if (listQuiz[numberOfQuestion].question_type == "multiple_choice"){
                correct_answer.textContent= `${listQuiz[numberOfQuestion].correct_answer.replace("%$№", " та ")}`
            }
            else{
                correct_answer.textContent= `${listQuiz[numberOfQuestion].correct_answer}`
            }
            
            document.cookie= `time=${Number(listQuiz[numberOfQuestion].time)}; path=/`
            resetTimer(Number(listQuiz[numberOfQuestion].time))

            const newTime = document.getElementById("timer")
            newTime.textContent =`${listQuiz[numberOfQuestion].time}`

            timerPaused= false
            plusAnswerTime= 0
            
            if (donatChart){
                donatChart.destroy()
            }
    
            socket.emit("next_question", {
                room: room,
                author_name: authorName
            });
        }

        function sendMessage() {
            let msgInput = document.getElementById("msg");
            let messages = document.getElementById("messages");
            let message = msgInput.value;

            if (message != ""){
                let messages = document.getElementById("messages");

                messages.innerHTML += `<p class="my-msg">${username}: ${msgInput.value}</p>`;  

                if (messages && messages.children.length != 1){
                    const emptyMessages= document.getElementById("no-messages");
                    if (emptyMessages){
                        emptyMessages.remove()
                    }
                }

                socket.emit("message_to_chat", {
                    message: message,
                    room: room,         
                    username: username  
                });
            }
            msgInput.value = "";
        }

        //function endTest() {
        //    let currentURL = window.location.href;
        //    let roomCode = currentURL.split('room')[1]
        //
        //    socket.emit("end_test", {
        //        room: room,         
        //        username: username  
        //    });
        //
        //    socket.emit("test_end", {
        //        room: roomCode
        //    });
        //    
        //    setTimeout(() => {
        //        window.location.href = '/'; 
        //    }, 200);
        //}

        function testStop(){    
            socket.emit("stop_test", {
                room: room,
                author_name: authorName
            });

            document.cookie = `state= authorResultTest; path=/`;
            renderAuthorResultTest(username, authorName, totalQuestion);
        }

        function checkAnswers(){
            state = getCookie("state");
            let answers = getCookie("userAnswers")
            
            if (answers) {
                let answersList = answers.split("|")
                let userAnswers = []
                let userAnswersList = []
                for (let answer of answersList){
                    if (answer != "|"){
                        userAnswers.push(answer)
                    }
                }
                for (let answer of userAnswers){
                    if (answer != ""){
                        userAnswersList.push(answer)
                    }
                }
                
                if (userAnswersList.length !== Number(state.slice(-1)) + 1) {
    
                    answers += "|not_answer|"
                    document.cookie = `userAnswers= ${answers}; path=/`;
                }
            }
            else {
                document.cookie = `userAnswers= |not_answer|; path=/`;
            }
        }

        function addUesrBlock(username, button){
            const userBlock= button.closest(".user-block")
            const userIP= userBlock.querySelector(".user-ip").textContent.trim()
            let addUserList= getCookie("userList")

            if (!addUserList){
                document.cookie= `userList= ${username}()${userIP}; path=/`
            } else {
                document.cookie= `userList= ${addUserList}</>${username}()${userIP}`
            }

            if (userBlock){
                userBlock.remove()
            }
            
            socket.emit("new_user", {
                room: room,
                username: username,
                author_name: authorName,
                user_ip: userIP ?? null
            });
        }

        function leaveTest(){
            window.location.href = `/`;
        }

        function leaveTestBlock(kick_user, ip, type){
            document.cookie = `compound=; max-age=0; path=/;`;
            document.cookie = `time=; max-age=0; path=/;`;
            window.location.href = `/`;
        }

        function kickUser(kick_user, ip, type) {   
            let UserList= getCookie("userList") || ""
            let users= UserList.split("</>").filter(username => username.trim() !== "")
            users= UserList.split("()").filter(username => username.trim() !== "")
            users = users.filter(username => username !== kick_user)

            // users.forEach(user, index => {

            // })
            const newUserList = users.join("</>")

            document.cookie= `userList=${newUserList}; path=/`
            socket.emit("kick_user", {
                room: room,
                user: kick_user
            });

            if (type === "block"){
                console.log("Block USER")

                let blockUserArray= getCookie("blockedUsers")
                if (!blockUserArray){
                    document.cookie = `blockedUsers=${ip}; path=/;`;
                } else{
                    document.cookie = `blockedUsers=${blockUserArray}$%^${ip}; path=/;`;
                }
            }

            let removeUserBlock= document.getElementById(`user${kick_user}`)

            if (removeUserBlock) {
                removeUserBlock.remove()
            }
        }

        function authorStartTest() {
            socket.emit("author_start_test", {
                room: room,
            });
        }

        </script>
    
{% endblock %}
