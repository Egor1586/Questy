{% extends "base.html" %}

{% block title %}
    Room
{% endblock %}

{% block links %}
    <link rel="stylesheet" href="{{ url_for('test_app.static', filename= 'css/room.css') }}">
{% endblock %}
    
{% block content %}

    <div id="room-main" class="content">
        <div class="waite-side" id="waite-side">
            <div class="info-bar">
                <div class="info-text">Author: {{ username }}</div>
                <div class="info-text">Test code: <strong>{{ test.test_code }}</strong></div>
            </div>

            <div class="user-list">
                <div class="user-block">
                    <div class="user-name">Автор: {{test.author_name }}</div>
                </div>
                {% for name in list_users %}
                    {% if test.author_name != name %}
                        <div class="user-block">
                            <div class="user-name">{{ name }}</div>
                            {% if test.author_name == username %}
                                <div class="user-actions">
                                    <button class="btn-remove" onclick="kickUser('{{ name }}')" type="button">Delete</button>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            {% if test.author_name == username %}
                    <button class= "btn-start" onclick="authorStartTest()" type="button">Start</button>
            {% endif %}
        </div>


        <div class="chat" id="chat">
            <h2>Chat</h2>
            <input id="msg" type="text" placeholder="Enter your message" class="msg-chat">
            <button onclick="sendMessage()" class="send-btn" type="button">Send</button>
            <div id="messages"></div>
        </div>
            
    </div>      

    {% if current_user.is_authenticated %}
        <script>
            
            const socket = io();
            const username = "{{ username }}";  
            const code = "{{ test.test_code }}"
            const test_id = "{{ test.id }}"

            socket.on("connect", function () {
                socket.emit("join", {
                    code: code,
                    username: username
                });
            });

            socket.on("listening_to_messages", function(data) {
                let messages = document.getElementById("messages");
                messages.innerHTML += `<p>${data}</p>`;
            });

            socket.on('kicked', function(data) {          
                window.location.href = '/'; 
            });

            socket.on('user_disconnected', function(data) {       
                let messages = document.getElementById("messages");
                messages.innerHTML += `<p>${data['msg']}</p>`;
            });

            socket.on('start_test', function(data) {
                let messages = document.getElementById("messages");
                messages.innerHTML += `<p>Start ${data["room"]}</p>`;
                if (username === data["author_name"]) {
                    // учитель 
                    console.log("Вы начали тест");
                    let waiteSide = document.getElementById('waite-side');
                    let chat = document.getElementById('chat');
                    let roomMain = document.getElementById('room-main');
                    if (waiteSide && chat){
                        waiteSide.remove();
                        chat.remove();
                            
                        let paragraph = document.createElement('p');
                        paragraph.id = 'just_text';
                        paragraph.textContent = 'Some text'
                        roomMain.appendChild(paragraph)
                        document.cookie = "state= author_start_test; path=/ ";
                    }
                    else {
                        console.log('нету блока')          
                    }               
                }
                else {
                    // ученик
                    console.log("Тест начат");
                    let roomMain = document.getElementById('room-main');
                    let waiteSide = document.getElementById('waite-side');
                    waiteSide.remove();
                    chat.remove();

                    document.cookie = "state= qustion1; path=/ ";
                    fetch(`http://127.0.0.1:5000/question`)
                    .then(response => response.text())
                    .then(html => {
                    document.getElementById('room-main').innerHTML = html;
                    });
                }
            });

            function sendMessage() {
                let msgInput = document.getElementById("msg");
                let message = msgInput.value;

                if (message != ""){
                    socket.emit("message_to_chat", {
                        message: message,
                        room: code,         
                        username: username  
                    });
                }
                msgInput.value = "";
            }

            function kickUser(kick_user) {
                socket.emit("kick_user", {
                    room: code,
                    user: kick_user
                });
            }

            function authorStartTest() {
                socket.emit("author_start_test", {
                    room: code
                }
                );
            }

        </script>

    {% endif %}
    
{% endblock %}