{% extends "class.html" %}

{% block calss_title %}
    Create Test
{% endblock %}

{% block class_links %}
    <link rel = "stylesheet" href = "{{ url_for('class_app.static', filename='css/class_page.css') }}">
{% endblock %}
{% block class_content %}
    <div class="content">  
        {% if is_teacher%}
            <div class="class-div">
                {% if my_classes_list%}
                    <h2>Доступні класи</h2>
                    
                    <div class="card-div">
                        {% for class in my_classes_list %} 
                            {% set tasks = tasks_class_teacher_list[loop.index0] %}
                            <div class="card with-tasks" id="{{tasks.title}}">
                                {% if class.class_color2 == None %}
                                    <div class="card-header" style="background: {{ class.class_color1 }};">
                                        <div class="card-info">
                                            <div class="left-info">
                                                Назва класу: {{ class.title }}<span>Урок: {{ class.lesson }}</span>
                                            </div>
                                            <div class="h-left-info">
                                                <span>Автор: {{ class.teacher.username }}</span><span>Код: {{ class.class_code }}</span>
                                            </div>
                                        </div>

                                        <div class="class-actions">
                                            <button class="more-class-actions">⋮</button>
                                            
                                            <div class="dropdown">
                                                <form action="/delete_class{{ class.id }}" method="post">
                                                    <button type="submit" class="dropdown-btn d">Видалити клас</button>
                                                </form>

                                                <a href="/class_information{{ class.id }}" class="dropdown-btn i">
                                                    Інформація про клас
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="card-header" style="background: linear-gradient(135deg, {{ class.class_color1 }}, {{ class.class_color2 }});">
                                        <div class="card-info">
                                            <div class="left-info">
                                                Назва класу: {{ class.title }}<span>Урок: {{ class.lesson }}</span>
                                            </div>
                                            <div class="h-left-info">
                                                <span>Автор: {{ class.teacher.username }}</span><span>Код: {{ class.class_code }}</span>
                                            </div>
                                        </div>

                                        <div class="class-actions">
                                            <button class="more-class-actions">⋮</button>
                                            
                                            <div class="dropdown">
                                                <form action="/delete_class{{ class.id }}" method="post">
                                                    <button type="submit" class="dropdown-btn d">Видалити клас</button>
                                                </form>

                                                <a href="/class_information{{ class.id }}" class="dropdown-btn i">
                                                    Інформація про клас
                                                </a>
                                            </div>
                                        </div>

                                    </div>
                                {% endif %}

                                <div class="card-body">
                                    <ul>
                                        {% for task in tasks %} 
                                            <li>
                                                {{ task.title }}
                                                <span class="due-time-p">
                                                    {% if task.due_time %}
                                                        - здати до {{ task.due_time.strftime('%d.%m.%Y %H:%M') }}
                                                    {% else %}
                                                        без дедлайну
                                                    {% endif %}
                                                </span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>

                                {% if class.class_color2 == None %}
                                    <div class="card-footer">
                                        <a href="/class_courses{{ class.id }}">
                                            <button class="start-btn" style="background: {{ class.class_color1 }};">
                                                Перейти до класу
                                            </button>
                                        </a>
                                        <a href="/create_task{{ class.id }}">
                                            <button class="start-btn" style="background: {{ class.class_color1 }};">
                                                Створити завдання
                                            </button>

                                        </a>
                                    </div>
                                {% else %}
                                    <div class="card-footer">
                                        <a href="/class_courses{{ class.id }}">
                                            <button class="start-btn" style="background: linear-gradient(135deg, {{ class.class_color1 }}, {{ class.class_color2 }});">
                                                Перейти до класу
                                            </button>
                                        </a>
                                        <a href="/create_task{{ class.id }}">
                                            <button class="start-btn" style="background: linear-gradient(135deg, {{ class.class_color1 }}, {{ class.class_color2 }});">
                                                Створити завдання
                                            </button>
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        {% endif %}
            
        {% if classes_list%}
            <div class="class-div">
                <h2>Мої класи</h2>
            
                <div class="card-div">       
                    {% for class in classes_list %}       
                        {% set tasks = tasks_class_user_list[loop.index0] %}
                          
                        <div class="card with-tasks">
                            {% if class.class_color2 == None %}
                                <div class="card-header" style="background: {{ class.class_color1 }};">
                                    <div class="h-left-info">
                                        Назва класу: {{ class.title }}<span>Урок: {{ class.lesson }}</span>
                                    </div>
                                    <span>Автор: {{ class.teacher.username }}</span>
                                </div>
                            {% else %}
                                <div class="card-header" style="background: linear-gradient(135deg, {{ class.class_color1 }}, {{ class.class_color2 }});">
                                    <div class="h-left-info">
                                        Назва класу: {{ class.title }}<span>Урок: {{ class.lesson }}</span>
                                    </div>
                                    <span>Автор: {{ class.teacher.username }}</span>
                                </div>
                            {% endif %}

                            <div class="card-body">
                                {% for task in tasks %} 
                                    <li>
                                        {{ task.title }}
                                        <span class="due-time-p">
                                            {% if task.due_time %}
                                                - здати до {{ task.due_time.strftime('%d.%m.%Y %H:%M') }}
                                            {% else %}
                                                без дедлайну
                                            {% endif %}
                                        </span>
                                    </li>
                                {% endfor %}
                            </div>
                
                            <div class="card-footer">
                                <a href="/class_courses{{ class.id }}">
                                    {% if class.class_color2 == None %}
                                        <button class="start-btn" style="background: {{ class.class_color1 }};">
                                            Перейти до класу
                                        </button>
                                    {% else %}
                                        <button class="start-btn" style="background: linear-gradient(135deg, {{ class.class_color1 }}, {{ class.class_color2 }});">
                                            Перейти до класу
                                        </button>
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        </div>
{% endblock %}

{% block class_modal %}
    <!-- Кнопка + -->
    <button class="add-btn">+</button>
    <ul class="menu-options">
        <li id="join-course-button">Приєднатися до класу</li>
        {% if is_teacher %}
            <li id="create-course-button">Створити клас</li>
        {% endif %}
    </ul>

    <!-- Форми -->
    <!-- Приєднатись -->
    <div class="modal-bg" id="modal-bg" style="display:none;">
        <div class="modal" id="join-form">
            <button class="back-btn" onclick="closeModal()">×</button>
            
            <form class="form" method="POST">
                <h2>Приєднатися до класу</h2>
                <div class="form-group">
                    <label>Код класу</label>
                    <h3>Попросіть у свого викладача код класу та введіть його тут.</h3>
                    <input type="text" placeholder="Введіть код" name="code" required>
                </div>
                <div class="form-group">
                    <label>Вимоги до входу за допомогою коду класу:</label>
                        <ul>
                            <li>Використовуйте авторизований обліковий запис</li>
                            <li>Код класу має містити лише літери або цифри (5–8) і не включати пробіли й спеціальні символи</li>
                        </ul>
                </div>
    
                <div class="bottom-button">
                    <button type="submit" class="join-course-btn">Приєднатися</button>
                </div>
            </form>
        </div>

        <!-- Створити -->
        <div class="modal" id="create-form" style="display:none;">
            <button class="back-btn" onclick="closeModal()">×</button>
            
            <form class="test-form" method="POST">
                <h2>Створити клас</h2>
                <div class="form-group">
                    <label>Назва класу:</label>
                    <input type="text" placeholder="Введіть назву класу" name="title" required>
                </div>
                <div class="form-group">
                    <label>Назва уроку:</label>
                    <input type="text" placeholder="Введіть назву уроку" name="lesson" required>
                </div>
                <div class="form-group">
                    <label>Колір класу:</label>
                    <select id="color-type" name="color-type">
                        <option value="single">Монотонний</option>
                        <option value="gradient">Градієнт</option>
                    </select>
                </div>
        
                <div class="form-group color-group" id="color-single">
                    <input type="color" value="#ff0000" name="color-m" required>
                </div>
                <div class="form-group color-group" id="color-gradient" style="display:none;">
                    <input type="color" value="#ff0000" name="color-g1" required>
                    <input type="color" value="#0000ff" name="color-g2" required>
                </div>
        
                <div class="form-group">
                    <label>Максимальна кількість учнів:</label>
                    <input type="number" placeholder="Введіть число" name="max-count" required>
                </div>
        
                <button class="join-course-btn" type="submit">Створити клас</button>
            </div>
        </form>
    </div>

    <script src="/class_app/static/js/newTask.js"></script>

    <script>
        const is_teacher = "{{ is_teacher | tojson }}"
        console.log(is_teacher)

        // Відкриття меню +
        const addBtn = document.querySelector('.add-btn')

        const menuOptions = document.querySelector('.menu-options')

        addBtn.addEventListener('click', () => {
            menuOptions.style.display = menuOptions.style.display === 'flex' ? 'none' : 'flex'
        })

        // Показ форми
        const modalBg = document.getElementById('modal-bg')
        const joinForm = document.getElementById('join-form')
        const createForm = document.getElementById('create-form')

        document.getElementById('join-course-button').addEventListener('click', () => {
            joinForm.style.display = 'block'
            createForm.style.display = 'none'
            modalBg.style.display = 'flex'
            menuOptions.style.display = 'none'
        })

        if (is_teacher){
            document.getElementById('create-course-button').addEventListener('click', () => {
                createForm.style.display = 'block'
                joinForm.style.display = 'none'
                modalBg.style.display = 'flex'
                menuOptions.style.display = 'none'
            })
        }

        // Закриття модалки
        function closeModal() {
            modalBg.style.display = 'none'
        }

        // Зміна вибору кольору
        const colorType = document.getElementById('color-type')
        colorType.addEventListener('change', () => {
            if (colorType.value === 'single') {
                document.getElementById('color-single').style.display = 'flex'
                document.getElementById('color-gradient').style.display = 'none'
            } else {
                document.getElementById('color-single').style.display = 'none'
                document.getElementById('color-gradient').style.display = 'flex'
            }
        })

        // Класи та їх видалення
        document.addEventListener("click", function(e) {
            const actions = e.target.closest(".class-actions")

            document.querySelectorAll(".class-actions").forEach(el => {
                el.classList.remove("show");
            })

            if (actions && e.target.closest(".more-class-actions")) {
                actions.classList.toggle("show")
            }
        });

    </script>      
{% endblock %}